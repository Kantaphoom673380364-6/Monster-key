<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monster Key – Co‑op</title>

  <!-- Socket.io client (served from your Node server) -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- Firebase (client SDK for saving leaderboard) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg: #0f1424;
      --panel: rgba(23,23,39,0.9);
      --gold: #fca311;
      --good: #55e076;
      --bad: #ff4d4d;
      --blue: #4da3ff;
      --red: #ff6b6b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      font-family: "Noto Sans Thai", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 70% -10%, #1f2540 0%, var(--bg) 55%);
      color: #e6e8ef;
      min-height: 100vh;
      display: grid;
      place-items: center;
    }
    .card {
      width: min(980px, 92vw);
      background: var(--panel);
      border: 2px solid var(--gold);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 0 26px rgba(252,163,17,.28);
    }
    h1 {
      font-family: Cinzel, Georgia, serif;
      letter-spacing: .5px;
      margin: 8px 0 18px;
      text-align: center;
      background: linear-gradient(90deg, #ffae42, #fff2cc, #fca311, #ffffff, #ffae42);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-size: 200% 100%;
      animation: shine 4s linear infinite;
      font-size: clamp(26px, 3.2vw, 38px);
    }
    @keyframes shine { 0%{background-position:200% 0}100%{background-position:-200% 0} }

    .row { display: grid; gap: 14px; }
    .setup-grid {
      display: grid;
      grid-template-columns: 1.4fr .8fr auto;
      gap: 10px;
      align-items: center;
    }
    input, select, button {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #364169;
      background: #121933;
      color: #e6e8ef;
      outline: none;
      font-size: 15px;
    }
    button.cta {
      border: 2px solid var(--gold);
      background: #1a1f38;
      cursor: pointer;
      transition: .2s ease;
      font-weight: 700;
      letter-spacing: .2px;
    }
    button.cta:hover { transform: translateY(-1px); box-shadow: 0 0 18px rgba(252,163,17,.35); }

    .muted { color: #9aa3c3; font-size: 14px; }

    .hidden { display: none !important; }

    /* Lobby */
    .pill { display: inline-flex; gap: 8px; align-items: center; padding: 8px 12px; background:#101632; border:1px solid #2a3561; border-radius: 999px; }
    .dot { width:10px; height:10px; border-radius:50%; background: var(--gold); box-shadow: 0 0 10px var(--gold); }

    /* Game area */
    .game-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: start;
    }
    .playerBox {
      padding: 12px;
      border-radius: 14px;
      border: 1px solid #2a3561;
      background: #121933;
    }
    .playerBox h3 { margin: 0 0 8px; font-weight: 800; font-size: 16px; }
    .p1 h3 { color: var(--blue); }
    .p2 h3 { color: var(--red); }
    .buffTag {
      font-size: 12px;
      border: 1px dashed var(--gold);
      padding: 4px 8px;
      border-radius: 999px;
      margin-left: 8px;
      color: var(--gold);
    }

    .bossBox {
      grid-column: 1 / -1;
      padding: 14px;
      border: 1px solid #2a3561;
      border-radius: 14px;
      background: #101632;
      text-align: center;
    }
    .hpBarOuter { width: 100%; height: 16px; border-radius: 999px; background: #2c2f4a; overflow: hidden; border: 1px solid #39406b; }
    .hpBarInner { height: 100%; width:100%; background: linear-gradient(90deg, #ff6961, #ff3838); transition: width .15s linear; }
    .word {
      font-size: clamp(22px, 3vw, 28px);
      letter-spacing: .8px;
      margin: 10px 0 6px;
    }
    .mini {
      font-size: 12px; color: #9aa3c3;
    }
    .center { text-align:center; }
    .flex { display:flex; gap:10px; align-items:center; justify-content:center; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Monster Key – โหมด Co‑op ออนไลน์ ⚔️</h1>

    <!-- ============= SETUP ============= -->
    <section id="setup" class="row">
      <div class="setup-grid">
        <input id="playerName" placeholder="ชื่อผู้เล่นของคุณ (จะแสดงในสกอร์)" />
        <select id="difficulty">
          <option value="easy">ง่าย</option>
          <option value="hard">ยาก</option>
        </select>
        <button id="findBtn" class="cta">ค้นหาผู้เล่น</button>
      </div>
      <div class="muted">ทั้งสองฝั่งต้องเลือกความยากเหมือนกัน ระบบจึงจะจับคู่ให้</div>
    </section>

    <!-- ============= LOBBY ============= -->
    <section id="lobby" class="row hidden center">
      <div class="pill"><span class="dot"></span> กำลังค้นหาผู้เล่นที่เลือกความยากเดียวกัน…</div>
      <div id="lobbyInfo" class="muted"></div>
    </section>

    <!-- ============= GAME ============= -->
    <section id="game" class="row hidden">
      <div class="game-grid">
        <!-- Players -->
        <div class="playerBox p1">
          <h3>Player (คุณ) <span id="buffMe" class="buffTag hidden">พลังโจมตี x2</span></h3>
          <div class="flex">
            <input id="inputMe" placeholder="พิมพ์คำแล้วกด Enter เพื่อโจมตี" />
            <button id="fireMe" class="cta">ยิง</button>
          </div>
        </div>
        <div class="playerBox p2">
          <h3>ผู้เล่นร่วมทีม <span id="buffMate" class="buffTag hidden">พลังโจมตี x2</span></h3>
          <div class="muted">ระบบจะแสดงผลการโจมตีของอีกฝั่งแบบเรียลไทม์</div>
        </div>

        <!-- Boss -->
        <div class="bossBox">
          <div><strong id="bossName">บอส 1/2</strong></div>
          <div class="hpBarOuter"><div id="hpInner" class="hpBarInner"></div></div>
          <div class="word" id="wordBox">ready…</div>
          <div class="mini" id="statusBox">เริ่มเมื่อพร้อม</div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ==================== Firebase ====================
    const firebaseConfig = {
      apiKey: "AIzaSyBUBIEQLU2OHw_1ataX1di6V86s0qPsr_E",
      authDomain: "typomancer-game.firebaseapp.com",
      projectId: "typomancer-game",
      storageBucket: "typomancer-game.appspot.com",
      messagingSenderId: "988104502180",
      appId: "1:988104502180:web:62dd3b80869a131b39ef31"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ==================== Socket.io ====================
    // เชื่อมกับเซิร์ฟเวอร์เดียวกัน (Same-origin)
    const socket = io();

    // ==================== State ====================
    const setupEl = document.getElementById("setup");
    const lobbyEl = document.getElementById("lobby");
    const lobbyInfo = document.getElementById("lobbyInfo");
    const gameEl  = document.getElementById("game");
    const inputMe = document.getElementById("inputMe");
    const fireMe  = document.getElementById("fireMe");
    const wordBox = document.getElementById("wordBox");
    const statusBox = document.getElementById("statusBox");
    const hpInner = document.getElementById("hpInner");
    const bossNameEl = document.getElementById("bossName");
    const buffMeTag = document.getElementById("buffMe");
    const buffMateTag = document.getElementById("buffMate");

    let roomId = null;
    let myName = "";
    let mateName = "";
    let difficulty = "easy";

    // คำศัพท์ตัวอย่าง (ควรแทนที่ด้วยของจริงถ้ามี)
    const WORDS = ["shadow","strike","ninja","katana","spirit","arcane","ember","void","storm","phantom","dragon","crimson","azure","onyx","quake","thunder"];
    function randWord(){ return WORDS[Math.floor(Math.random()*WORDS.length)]; }

    // บอส 2 ตัว
    const BOSS_LIST = [
      { name: "Orc Warlord", maxHp: 1200, baseDmg: 50 },
      { name: "Demon Overlord", maxHp: 1600, baseDmg: 50 }
    ];
    let bossIndex = 0;
    let bossHp = BOSS_LIST[0].maxHp;

    // Buff (แยกกันสองฝั่ง)
    let myBuff = { active:false, until:0, mult:2 };
    let mateBuff = { active:false, until:0, mult:2 };

    // เวลา / ชนะ
    let startTime = 0;
    let bossesDefeated = 0;
    let finished = false;

    function setHpBar() {
      const pct = Math.max(0, Math.round((bossHp / BOSS_LIST[bossIndex].maxHp) * 100));
      hpInner.style.width = pct + "%";
    }

    function newWord() {
      wordBox.textContent = randWord();
      inputMe.value = "";
      inputMe.focus();
    }

    function startFight() {
      const b = BOSS_LIST[bossIndex];
      bossHp = b.maxHp;
      bossNameEl.textContent = `${b.name} (${bossIndex+1}/2)`;
      statusBox.textContent = "พิมพ์คำให้ถูกเพื่อโจมตีบอส!";
      setHpBar();
      newWord();
      if (bossIndex === 0) startTime = Date.now();
    }

    function tryBuffActivate() {
      // โอกาส 18% ต่อคำ
      if (!myBuff.active && Math.random() < 0.18) {
        myBuff.active = true;
        myBuff.until = Date.now() + 8000;
        buffMeTag.classList.remove("hidden");
        // แจ้งอีกฝั่งให้โชว์สถานะของเรา
        socket.emit("syncBuff", { roomId, who:"me", active:true, until:myBuff.until });
        // ตั้ง timeout ปิดบัฟ
        setTimeout(()=>{
          myBuff.active = false;
          buffMeTag.classList.add("hidden");
          socket.emit("syncBuff", { roomId, who:"me", active:false, until:0 });
        }, 8000);
      }
    }

    function onCorrectWord() {
      const base = (difficulty === "hard") ? 140 : 90;
      const dmg = myBuff.active ? base * myBuff.mult : base;
      socket.emit("attackBoss", { roomId, damage: dmg });
      tryBuffActivate();
      newWord();
    }

    // คลิก/กด Enter เพื่อยิง
    fireMe.addEventListener("click", ()=>{
      if (inputMe.value.trim().toLowerCase() === wordBox.textContent) onCorrectWord();
      else statusBox.textContent = "สะกดผิด ลองใหม่!";
    });
    inputMe.addEventListener("keydown", (e)=>{
      if (e.key === "Enter") {
        if (inputMe.value.trim().toLowerCase() === wordBox.textContent) onCorrectWord();
        else statusBox.textContent = "สะกดผิด ลองใหม่!";
      }
    });

    // ==================== Matchmaking Flow ====================
    document.getElementById("findBtn").addEventListener("click", () => {
      myName = document.getElementById("playerName").value.trim();
      difficulty = document.getElementById("difficulty").value;
      if (!myName) { alert("กรุณากรอกชื่อก่อน"); return; }

      // ขอจับคู่
      socket.emit("findMatch", { playerName: myName, difficulty });
      setupEl.classList.add("hidden");
      lobbyEl.classList.remove("hidden");
      lobbyInfo.textContent = `ชื่อของคุณ: ${myName} • ความยาก: ${difficulty === "hard" ? "ยาก" : "ง่าย"}`;
    });

    socket.on("waiting", (msg)=>{
      lobbyInfo.textContent = msg || "กำลังรอผู้เล่นอีกคน…";
    });

    socket.on("matchFound", (payload)=>{
      // payload: { roomId, partner }
      roomId = payload.roomId;
      mateName = payload.partner || "Teammate";
      lobbyEl.classList.add("hidden");
      gameEl.classList.remove("hidden");
      statusBox.textContent = `ต่อสู้ร่วมกับ ${mateName}!`;
      bossIndex = 0;
      startFight();
    });

    // ==================== Real-time Combat Sync ====================
    socket.on("bossAttacked", (dmg)=>{
      // อีกฝั่งหรือเราทำดาเมจ → หัก HP ร่วมกัน
      bossHp -= dmg;
      setHpBar();

      if (bossHp <= 0 && !finished) {
        bossesDefeated++;
        if (bossIndex === 0) {
          // ไปตัวที่ 2
          bossIndex = 1;
          setTimeout(startFight, 400);
        } else {
          // เคลียร์เกม
          finished = true;
          const totalTimeSec = (Date.now() - startTime) / 1000;
          statusBox.textContent = `กำจัดบอสครบ! เวลา ${totalTimeSec.toFixed(2)} วิ`;
          saveCoopScore(totalTimeSec);
        }
      }
    });

    socket.on("buffSync", ({ who, active })=>{
      // โชว์สถานะบัฟของอีกฝั่งเท่านั้น
      if (who === "me") return; // ข้อมูลของเราเองไม่ต้องทับ
      if (active) buffMateTag.classList.remove("hidden");
      else buffMateTag.classList.add("hidden");
    });

    // ==================== Save to Firestore (Co-op board) ====================
    async function saveCoopScore(totalSec) {
      try {
        const pairName = `${myName} & ${mateName} (Co-op)`;
        await db.collection("leaderboard").add({
          name: pairName,
          time: totalSec,
          bossesDefeated: 2,
          mode: (difficulty === "hard") ? "ยาก" : "ง่าย",
          gameType: "coop",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        statusBox.textContent += " • บันทึกคะแนนสำเร็จ!";
      } catch (e) {
        console.error("saveCoopScore error", e);
        statusBox.textContent += " • บันทึกคะแนนล้มเหลว";
      }
    }

    // ==================== Helper socket relays ====================
    // แจ้งอีกฝั่งเรื่องบัฟของเรา
    socket.on("connect", ()=>{
      // connected
    });

    // เมื่อเราเปิด/ปิดบัฟ → แจ้งผ่าน emit แล้ว server ต้อง broadcast เป็น 'buffSync'
    // (ใน Server.js ให้รองรับ event 'syncBuff' → io.to(roomId).emit('buffSync', payload))

  </script>
</body>
</html>
